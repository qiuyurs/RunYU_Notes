---
title: IPv6无状态地址配置详解
description: 详细介绍IPv6无状态地址自动配置协议(NDP)的工作原理、RA报文解析及华为/锐捷设备配置方法
tags: [IPv6, NDP协议, 无状态地址配置, 路由器通告, 网络配置]
date: 2023-12-04T21:27:21Z
lastmod: 2024-05-02T13:52:37Z
---
## IPV6

### 无状态地址获取

　　**无状态**地址使用 ND（Neighbor Discovery）协议，ND 协议代替了 IPv4 中的 ARP 协议（Address Resolution Protocol）、ICMP 路由设备发现消息（Router Discovery），并提供了其他功能，如邻居不可达检测（NUD）、重复**地址**检查（DAD）、**地址**自动配置等。

　　**无状态**地址配置方式的流程如下：

1. 客户端在启动后使用本地链路前缀 FE80::0＋ 接口 ID 生成本地链路**地址**。
2. 客户端对本地链路**地址**执行 DAD（Duplicate Address Detection）检测，发送 NS（Neighbor Solicitation，邻居请求）报文在广播域范围内检测该**地址**是否冲突。若接收到其他设备发送的 NA（Neighbor Advertisement，邻居通告）报文，说明本地链路**地址**冲突，需要重设置本地链路**地址**，设置完毕后还需要执行 DAD 检测，直到本地链路**地址**不冲突为止。
3. 客户端发送 RS（Router Solicitation，路由器请求）报文。
4. **路由器**回应 RA（Router Advertisement，路由器应答）报文，包含以下信息：

   * 是否使用**地址**自动配置。
   * 标记支持的自动配置类型（**无状态**或有**状态**自动配置）。
   * 一个或多个链路前缀（本地链路上的节点可以使用这些前缀完成**地址**自动配置）。
   * 链路前缀的生命周期。
   * 发送路由器通告的路由设备是否可作为缺省路由设备，如果可以，还包括此路由设备可作为缺省路由设备的时间（用秒表示）。
   * 与客户端相关的其它配置信息，如跳数限制、客户端发起的报文能够使用的最大 MTU 等。
5. 客户端收到 RA 报文，若 RA 报文中指定使用**无状态**地址自动配置，并且携带了正确的链路前缀，使用这些前缀和接口 ID 生成全球单播**地址**，然后对每个**地址**进行 DAD 检测；若 RA 报文中指定了使用有**状态**的方式获取**地址**外的其他配置信息，则客户端需要发送 DHCPv6 Information-request 报文请求配置信息；若 RA 报文中指定使用**地址**有**状态**地址配置，则主机发送 DHCPv6 Solicit 报文获取**地址**和其他配置信息。

#### RA 报文解析

　　Pv6 路由器周期性发送 ICMPv6 路由器通告 RA（RouterAdvertisement）消息，或者在收到路由请求 RS（Router Solicitation）消息时回应 ICMPv6 RA 消息。ICMPv6 RA 消息包括前缀和一些标志位的信息。

　　报文格式：

```shell
+0--------------7--------------15----------------------------31
|      Type     |     Code     |           Checksum          |
+-------------------------------------------------------------
| Cur Hop Limit |M|O| Reserved |        Router Lifetime      |
+-------------------------------------------------------------
|                       Reachable Time                       |
+-------------------------------------------------------------
|                        Retrans Time                        |
+-------------------------------------------------------------
|                           Options...                       |
+------------------------------------------------------------+
```

|字段|长度|含义|
| ---------------| ------| --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|Type|1 字节|消息类型，此处值为 134。|
|Code|1 字节|该 ICMPv6 差错报文的始发者必须将该字段置为 0，且接收端忽略该字段。|
|Checksum|2 字节|用来在 ICMPv6 报文中检验数据和部分 IPv6 首部的完整性。|
|Cur Hop Limit|1 字节|8 位无符号整数。默认值应当放置在发出 IP 分组的 IP 首部的 Hop Count 字段中。 取 0 值意味着未(由该路由器)规定。|
|M|1 比特|1 位“管理地址配置”标记。当置 1 时，它指出地址可通过 Dynamic Host Configuration 协议获得。如果 M 标记置 1，则 O 标记为冗余，可以忽略，因为 DHCPv6 将返回所有可用配置信息。|
|O|1 比特|1 位“其他配置”标记。当 M=0 且 O=1 时，指示其他配置信息可通过 DHCPv6 获得。例如，这类信息包括 DNS 相关信息或关于网络内其他服务器的信息。如果 M=0 且 O=0，指示没有信息可通过 DHCPv6 获得。|
|Reserved|6 比特|6 位未使用字段。它必须由发送者初始化为 0，接收者必须忽略它。|
|Router Lifetime|2 字节|16 位无符号整数。与默认路由器关联的生存期，以秒为单位。最大值 18.2 小时。取 0 值的 Lifetime 指出路由器不是默认路由器并且不应当出现在默认路由器列表中。Router Lifetime 仅适用于作为默认路由器的路由器应用；对包括在其他消息字段或选项中的信息不适用。需要对它们的信息规定时间限制的选项有它们自己的生存期字段。|
|Reachable Time|4 字节|32 位无符号整数。此时间以毫秒计，在收到可达性确认后节点假定该邻居是可到达的。它由 Neighbor Unreachability Detection 算法使用(参阅第 7-3 节)。此值为 0 意味着没有(由此路由器)作出规定。|
|Retrans Timer|4 字节|32 位无符号整数。重发的 Neighbor Solicitation 消息间隔时间，以毫秒计。由地址解析和 Neighbor Unreachability Detection 算法使用。此值为 0 意味着没有(由此路由器)作出规定。|
|Options|可变|选项* Source link-layer address：源链路层地址，发出 Router Advertisement 的接口的链路层地址。仅在有地址的链路层上使用。路由器可以忽略此选项，以便能够使入境负载跨多个链路层地址共享。为 TLV 格式，各字段含义如下：* Type: = 1，长度是 1 字节。* Length: 1 字节，选项的长度(包括类型字段和长度字段)，以 8 字节为单位计算。例如，IEEE802 地址的长度是 1。* Link-Layer Address: 可变长度的链路层地址。此字段的内容和形式(包括字节和比特顺序)一般由描述 IPv6 在不同链路层上如何运行的特定文件中规定。* MTU：在有可变 MTU 的链路上应当按此发送流量(正如在描述特定链路类型上如何 运行 IP 的文件中规定的)。可以按此在其他链路上发送流量。MTU 格式：* Type = 5* Length = 1* Reserved: 此字段未使用。它必须被发送者初始化为 0，接收者必须忽略它。* MTU: 32 位无符号整数。是为此链路推荐的 MTU。* Prefix Information：这些选项规定了前缀，这些前缀是 on-link 的，和/或被用于地址自动配置。路由器应当包括所有它的 on-link 前缀(链路本地前缀除外)，所以多归属第主机有 完整的前缀信息，这些前缀是关于主机们附着的链路的 on-link 目的地的。如果缺乏完整信息，当发送流量到它的邻居们时，多归属地主机或许不能够选择正确的出接口。 Type: = 3* Length: = 4* Prefix Length: 8 位无符号整数。在合法前缀中领先比特的数目。其值范围是 0 到 128。前缀长度字段为 on-link 确定提供必须的信息(当与前缀信息选项中 L 标记相结合时)。它也帮助实现地址自动配置，对此存在更多关于前缀长度的限制。* L: 1 位 on-link 标记。当置 1 时，指出此前缀可用于 on-link 确定。当没有置 1 时，通告对此前缀的 on-link 或 off-link 性质没有说明。换句话讲，如果 L 标记没有置 1，主机不能推断出从该前缀引申出的地址是 off-link。即，主机不能更新先前关于地址是 on-link 的指示。* A: 1 位自动地址配置标记。当置 1 时，指出此前缀可用于无状态地址自动配置。* Reserved1: 6 位未使用字段。必须被发送者初始化为 0，接收者必须忽略它。* Valid Lifetime: 32 位无符号整数。时间长度以秒为单位(相对于分组被发送的时间)，在此时间内此前缀对于 on-link 确定来说是合法的。全 1 比特值(0xffffffff)表示无限。* Preferred Lifetime: 32 位无符号整数。时间长度以秒为单位(相对于分组被发送的时间)。在此时间 内经无状态地址自动配置，根据此前缀生成的地址保有优先权[ADDRCONF]。全 1 比特值(0xffffffff)表示无限。注意，此字段的值不能超过 Valid Lifetime 字段的值，以避免优先的地址不再合法。* Reserved2: 此字段未使用。它必须被发送者初始化为 0，接收者必须忽略它。* Prefix: IP 地址或 IP 地址的前缀。Prefix Length 字段包含此前缀中有效领先比特的数目。在前缀中，在前缀长度之后的这些位被保留，并且必须被发送者初始化为 0，接收者必须忽略它们。路由器不应当发送链路本地前缀的前缀选项，主机应当忽略这种前缀选项。|

　　O=0 时 无状态自动配置

　　O=1 时 PC 从 DHCPv6 服务器获取除地址外的其他参数

　　M=0   O=0  无状态自动配置

　　M=0   O=1   地址无状态，dns 等其他配置请求 dhcp

　　‍

　　**华为配置**

```shell
ipv6  // 全局开启ipv6
int g0/0/0 
undo ipv6 nd ra halt  // 允许发送RA报文，必须开启
ipv6 nd autoconfig managed-address-flag  // M位置1 非必须
ipv6 nd autoconfig other-flag   // O位置1 非必须

ipv6 address auto global default // 无状态自动配置ip
```

　　**锐捷配置**

```shell
ipv6 unicast-routing  // 开启ipv6单播路由转发
no ipv6 nd suppress-ra  // 允许发送RA报文
ipv6 nd managed-config-flag // M位置1 非必须
ipv6 nd other-config-flag // O位置1 非必须

ipv6 address autoconfig // 无状态自动配置ip
```
